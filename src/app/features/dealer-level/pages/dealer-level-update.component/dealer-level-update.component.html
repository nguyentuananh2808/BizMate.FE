<div class="flex">
  <app-menu class="bg-background-dark"></app-menu>

  <div class="bg-login" [ngClass]="{ dark: isDark }">
    <div
      class="px-4 pt-6 z-10 relative"
      [ngClass]="{ 'dark:bg-gray-900': isDark }"
    >
      <!-- Mobile header bar -->
      <div
        *ngIf="isMobile"
        class="fixed bg-[rgb(247,251,255)] dark:bg-background-dark p-3 rounded-[24px] w-[94%] mb-16"
      >
        <!-- Header -->
        <header-common></header-common>

        <!-- Mobile header bar -->
        <div
          *ngIf="isMobile"
          class="mb-4 flex items-center justify-between gap-3"
        >
          <!-- Nút Quay lại -->
          <button
            type="button"
            class="rounded-full bg-gray-200 text-gray-700 px-2 py-1 hover:bg-gray-300 transition flex items-center w-8 h-8"
            (click)="goBack()"
            [ngClass]="{
              'dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600':
                isDark
            }"
          >
            <nz-icon nzType="arrow-left" nzTheme="outline"></nz-icon>
          </button>

          <!-- Ô tìm kiếm căn giữa -->
          <input
            type="text"
            class="flex-1 border border-gray-300 rounded-[24px] px-3 py-2 mx-2"
            [(ngModel)]="searchKeyword"
            (ngModelChange)="onSearch()"
            placeholder="Tìm kiếm..."
            [ngClass]="{
              'dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600': isDark
            }"
          />
          <!-- Print Button -->
          <!-- <button
            (click)="onPrint()"
            type="button"
            class="px-3 py-2 rounded-[24px] bg-green-600 text-white hover:bg-green-700 transition whitespace-nowrap flex items-center gap-1"
          >
            <nz-icon nzType="printer" nzTheme="outline"></nz-icon>
          </button> -->
        </div>

        <!-- Mobile Form -->
        <div
          *ngIf="isMobile"
          class="bg-[rgba(233,233,233,0.87)] dark:bg-gray-900 flex flex-col rounded-[24px]"
        >
          <!-- Scrollable content -->
          <div class="overflow-y-auto px-3 py-4 space-y-4 max-h-[76vh]">
            <div
              class="shadow-lg rounded-[24px] overflow-hidden p-4 w-full m-1"
              [ngClass]="{ 'dark:bg-gray-900': isDark }"
            >
              <form [formGroup]="dealerLevelForm" class="space-y-4">
                <!-- Các input -->
                <div>
                  <label
                    class="block mb-1 text-secondary-light dark:text-secondary-dark"
                  >
                    Đại lý cấp
                  </label>
                  <input
                    formControlName="dealerLevelName"
                    class="input-style w-full"
                    placeholder="Nhập đại lý cấp..."
                  />
                </div>

                <div class="flex justify-end">
                  <button
                    nz-button
                    nzType="default"
                    class="items-center gap-4 whitespace-nowrap rounded-[24px] h-10 mb-3 text-[12px] mr-1"
                    (click)="addProducts()"
                  >
                    <nz-icon nzType="plus-circle" nzTheme="outline"></nz-icon>
                    Thêm sp
                  </button>
                  <button
                    nz-button
                    nzType="primary"
                    class="rounded-[24px] h-10 px-6 text-[12px]"
                    (click)="submitForm()"
                  >
                    <nz-icon nzType="save" nzTheme="outline"></nz-icon>
                    <span *ngIf="isSubmitting">Đang cập nhật...</span>
                    <span *ngIf="!isSubmitting">Cập nhật đại lý</span>
                  </button>
                </div>
              </form>

              <!-- Danh sách sản phẩm -->
              <div class="mt-4">
                <div class="flex justify-between items-center mb-2">
                  <h3
                    class="text-base font-semibold text-secondary-light dark:text-secondary-dark"
                  >
                    Sản phẩm đã chọn
                  </h3>
                </div>

                <div
                  *ngIf="listOfData.length === 0"
                  class="text-sm text-gray-500"
                >
                  Chưa có sản phẩm nào.
                </div>

                <div
                  *ngFor="let item of listOfData"
                  class="mb-2 p-3 rounded-lg bg-white shadow dark:bg-gray-800 text-sm"
                >
                  <div
                    class="font-medium text-secondary-light dark:text-secondary-dark"
                  >
                    {{ item.ProductName }}
                  </div>
                  <div class="text-secondary-light dark:text-secondary-dark">
                    <div>Mã: {{ item.ProductCode }}</div>
                    <div class="flex items-center gap-2">
                      <label
                        class="text-secondary-light dark:text-secondary-dark mb-0"
                        >Giá:</label
                      >

                      <ng-container
                        *ngIf="editingId === item.ProductId; else displayPrice"
                      >
                        <input
                          type="number"
                          min="1"
                          [(ngModel)]="editingPrice"
                          (ngModelChange)="onPriceChange()"
                          [ngModelOptions]="{ standalone: true }"
                          class="w-20 px-2 py-1 border rounded text-black bg-white"
                          (blur)="saveEdit(item)"
                          (keydown.enter)="saveEdit(item)"
                        />
                      </ng-container>

                      <ng-template #displayPrice>
                        <span
                          class="cursor-pointer font-semibol"
                          [ngClass]="{
                            'text-danger-light dark:text-danger-dark font-bold':
                              item.Price <= 0,
                            'text-success-light dark:text-success-dark font-medium':
                              item.Price > 0,
                            'input-error': inputError
                          }"
                          (click)="startEdit(item)"
                        >
                          {{ item.Price | price }}
                        </span>
                      </ng-template>
                    </div>
                  </div>
                   <button
                    class="mt-2 text-red-500 text-xs"
                    (click)="deleteItem(item)"
                  >
                    Xóa
                  </button> 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Desktop header bar -->
      <div *ngIf="!isMobile">
        <!-- Header -->
        <header-common></header-common>
        <div class="mb-4 flex items-center justify-between gap-4">
          <!-- page name -->
          <h1
            class="text-secondary-light dark:text-secondary-dark text-2xl font-bold"
          >
            Cập nhật đại lý cấp
          </h1>

          <!-- Ô tìm kiếm căn giữa -->
          <input
            type="text"
            class="border border-gray-300 rounded-[24px] px-3 py-2 w-[58%] mx-auto"
            [(ngModel)]="searchKeyword"
            (ngModelChange)="onSearch()"
            placeholder="Tìm kiếm..."
            [ngClass]="{
              'dark:bg-gray-800 dark:text-gray-100 dark:border-gray-600': isDark
            }"
          />

          <!-- Nhóm nút -->
          <div class="flex gap-3">
            <!-- Nút Quay lại -->
            <button
              type="button"
              class="rounded-full bg-gray-200 text-gray-700 px-4 py-2 hover:bg-gray-300 transition flex items-center gap-2"
              (click)="goBack()"
              [ngClass]="{
                'dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600':
                  isDark
              }"
            >
              <span>Quay lại</span>
              <nz-icon nzType="arrow-right" nzTheme="outline"></nz-icon>
            </button>
          </div>
        </div>
      </div>

      <!-- desktop -->
      <div *ngIf="!isMobile">
        <div
          class="bg-background-lightblue dark:bg-background-dark shadow-lg rounded-[24px] overflow-hidden p-3 w-full"
          [ngClass]="{ 'dark:bg-gray-900': isDark }"
        >
          <div class="w-full">
            <form [formGroup]="dealerLevelForm" class="space-y-6 pl-3 pt-3">
              <div class="grid gap-4">
                <div>
                  <label
                    class="block mb-1 text-secondary-light dark:text-secondary-dark"
                  >
                    Đại lý cấp
                  </label>
                  <input
                    formControlName="dealerLevelName"
                    class="input-style"
                    placeholder="Nhập đại lý cấp..."
                  />
                </div>
              </div>

              <!-- Table Section -->
              <div class="grid grid-cols-2">
                <div>
                  <h3
                    class="text-lg font-semibold text-secondary-light dark:text-secondary-dark"
                  >
                    Danh sách sản phẩm
                  </h3>
                </div>
                <div class="flex justify-end">
                  <button
                    nz-button
                    nzType="default"
                    class="items-center gap-2 whitespace-nowrap rounded-[24px] h-10 mb-3"
                    (click)="addProducts()"
                  >
                    <nz-icon nzType="plus-circle" nzTheme="outline"></nz-icon>
                    Thêm sản phẩm
                  </button>

                  <div class="flex justify-end ml-2">
                    <button
                      nz-button
                      nzType="primary"
                      class="rounded-[24px] h-10 px-6"
                      (click)="submitForm()"
                    >
                      <nz-icon nzType="save" nzTheme="outline"></nz-icon>
                      <span *ngIf="isSubmitting">Đang cập nhật...</span>
                      <span *ngIf="!isSubmitting">Cập nhật đại lý cấp</span>
                    </button>
                  </div>
                </div>
              </div>

              <nz-table
                [nzData]="listOfData"
                [nzBordered]="false"
                [nzSize]="'middle'"
                [nzScroll]="{ x: '1000px', y: '300px' }"
                [nzShowPagination]="false"
              >
                <thead>
                  <tr class="text-gray-500 dark:bg-gray-700 dark:text-gray-400">
                    <!-- <th [nzWidth]="'20px'" class="text-center"></th> -->
                    <th [nzWidth]="'20px'" class="text-center">STT</th>
                    <th [nzWidth]="'20px'"></th>
                    <th [nzWidth]="'80px'">Mã sản phẩm</th>
                    <th [nzWidth]="'240px'">Tên sản phẩm</th>
                    <th [nzWidth]="'100px'">Giá</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let item of listOfData; let i = index"
                    class="hover:bg-gray-50 transition-all duration-150"
                    [ngClass]="{ 'dark:hover:bg-gray-800': isDark }"
                  >
                    <!-- <td class="text-center">
                      <label nz-checkbox></label>
                    </td> -->
                    <td class="text-center">{{ i + 1 }}</td>
                    <td class="space-x-2 flex">
                      <button
                        nz-button
                        nzType="link"
                        class="text-red-600"
                        (click)="deleteItem(item)"
                      >
                        <nz-icon nzType="delete" nzTheme="outline"></nz-icon>
                      </button>
                    </td>
                    <td>{{ item.ProductCode }}</td>
                    <td>{{ item.ProductName }}</td>
                    <td
                      [ngClass]="{
                        'text-danger-light dark:text-danger-dark font-bold':
                          item.Price <= 0,
                        'text-success-light dark:text-success-dark font-medium':
                          item.Price > 0
                      }"
                    >
                      <ng-container
                        *ngIf="editingId === item.ProductId; else displayPrice"
                      >
                        <div class="flex items-center space-x-2">
                          <input
                            type="number"
                            min="1"
                            [(ngModel)]="editingPrice"
                            [ngModelOptions]="{ standalone: true }"
                            (ngModelChange)="onPriceChange()"
                            [ngClass]="{ 'input-error': inputError }"
                            class="w-20 px-2 py-1 border border-gray-300 rounded"
                            (blur)="saveEdit(item)"
                            (keydown.enter)="saveEdit(item)"
                          />
                        </div>
                      </ng-container>
                      <ng-template #displayPrice>
                        <span
                          class="cursor-pointer"
                          (click)="startEdit(item)"
                          >{{ item.Price | price }}</span
                        >
                      </ng-template>
                    </td>
                  </tr>
                </tbody>
              </nz-table>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom menu -->
    <bottom-menu class="mt-6"></bottom-menu>
    <product-popup-search
      *ngIf="isPopupSearchProducts"
      [shouldDisableProduct]="false"
      [existingProducts]="existingProductIds"
      (closePopup)="closeProductPopup()"
      (selectProducts)="onSelectedProducts($event)"
    ></product-popup-search>
  </div>
</div>
